<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/docs/4.0/assets/img/favicons/favicon.ico">
    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/product/">

    <!-- Bootstrap core CSS -->
    <link href="{{url_for('static',filename='bootstrap.min.css')}}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{{url_for('static', filename='main.css')}}" rel="stylesheet">

     <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2/dist/chart.min.js"></script>
    {% extends "base.html" %}

    {% block title %}
      Flight
    {% endblock %}
  </head>

  <body>
    {% block content %}

    <!-- Gauges -->
        <div class="container">
            <div class="row justify-content-around my-5">
                <div class="col-4 text-center">
                    <h4>Temperature (°C)</h4>
                    <div id="tempGauge"></div>
                </div>
                <div class="col-4 text-center">
                    <h4>Battery (%)</h4>
                    <div id="batteryGauge"></div>
                </div>
                <div class="col-4 text-center">
                    <h4>Altitude (cm)</h4>
                    <div id="altitudeGauge"></div>
                </div>
            </div>
        </div>

    <div class="container">
            <div class="row justify-content-around my-5">
               <div class="col-4 text-center">
                    <h4>Yaw</h4>
                    <div id="yawGauge"></div>
                </div>
                <div class="col-4 text-center">
                    <h4>Pitch</h4>
                    <div id="pitchGauge"></div>
                </div>
                  <div class="col-4 text-center">
                    <h4>Roll</h4>
                    <div id="rollGauge"></div>
                </div>

            </div>
        </div>

     <!-- Plot with gridlines and buttons -->
<div class="container">
  <div class="row justify-content-center my-5">
    <div class="col-8 text-center">
      <h4>Drone Coordinates</h4>
      <canvas id="droneCoords"></canvas>
    </div>
    <div class="col-4">
      <h4>Controls</h4>
      <div class="d-flex flex-column">
        <button id="startBtn" class="btn btn-info mb-3">Start</button>
        <button id="hoverBtn" class="btn btn-warning mb-3">Hover</button>
        <button id="emergencyStopBtn" class="btn btn-dark mb-3">Emergency Stop</button>
      </div>
    </div>
  </div>
</div>

    <script>
      // Add event listeners to buttons
  document.getElementById('startBtn').addEventListener('click', () => {
    fetch('/start_drone_mission', { method: 'POST' });
  });

  document.getElementById('hoverBtn').addEventListener('click', () => {
    fetch('/hover_drone', { method: 'POST' });
  });

  document.getElementById('emergencyStopBtn').addEventListener('click', () => {
    fetch('/emergency_shutoff', { method: 'POST' });
  });



  // Set up the gauges
  var tempGauge = new JustGage({
    id: "tempGauge",
    value: 0,
    min: 30,
    max: 90,
    title: "Temperature",
    label: "°C"
  });

  var batteryGauge = new JustGage({
    id: "batteryGauge",
    value: 0,
    min: 0,
    max: 100,
    title: "Battery",
    label: "%"
  });

  var altitudeGauge = new JustGage({
    id: "altitudeGauge",
    value: 0,
    min: 0,
    max: 500,
    title: "Altitude",
    label: "cm"
  });

  var pitchGauge = new JustGage({
      id: "pitchGauge",
      value: 0,
      min: -180,
      max: 180,
      title: "Pitch",
      label: "degrees"
  });

  var rollGauge = new JustGage({
      id: "rollGauge",
      value: 0,
      min: -180,
      max: 180,
      title: "Roll",
      label: "degrees"
  });

  var yawGauge = new JustGage({
      id: "yawGauge",
      value: 0,
      min: -180,
      max: 180,
      title: "Yaw",
      label: "degrees"
  });



  // Function to update the gauges with new data
  function updateGauges() {
    fetch('/get_tello_data')
      .then(response => response.json())
      .then(data => {
        // Update the temperature gauge

          if (data.templ && data.temph) {
          tempGauge.refresh((data.templ + data.temph) / 2);
        }

        // Update the battery gauge
        if (data.bat) {
          batteryGauge.refresh(data.bat);
        }

        // Update the altitude gauge
        if (data.h) {
          altitudeGauge.refresh(data.h);
        }

        if(data.pitch){
            pitchGauge.refresh(data.pitch);
        }

        if(data.roll){
            rollGauge.refresh(data.roll);
        }
        if(data.yaw){
            yawGauge.refresh(data.yaw);
        }



      });
  }

  // Update the gauges every .5 seconds
  setInterval(updateGauges, 500);
</script>

       <script>
      // (Existing script for gauges)

      // Set up the plot
      const ctx = document.getElementById('droneCoords').getContext('2d');
      const droneCoordsChart = new Chart(ctx, {
  type: 'scatter',
  data: {
    datasets: [
      {
        label: 'Drone Coordinates',
        data: [],
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
      },
      {
        label: 'Anchor Locations',
        data: [
          { x: 0, y: 0, label: 'A' },
          { x: 3, y: 0, label: 'B' },
        ],
        backgroundColor: ['rgba(0, 0, 255, 0.8)', 'rgba(255, 0, 0, 0.8)'],
        borderColor: ['rgba(0, 0, 255, 1)', 'rgba(255, 0, 0, 1)'],
        borderWidth: 1,
        pointRadius: 5,
        pointHoverRadius: 7,
      },
         {
                    label: 'Drop-off Locations',
                    data: [],
                    backgroundColor: 'rgba(255, 0, 0, 0.2)',
                    borderColor: 'rgba(255, 0, 0, 1)',
                    borderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }
    ],
  },
  options: {
    plugins: {
      tooltip: {
        callbacks: {
          title: function (context) {
            return context[0].element.$context.dataset.data[context[0].dataIndex].label;
          },
        },
      },
    },
    scales: {
      x: {
        type: 'linear',
        min: -10,
        max: 10,
        grid: {
          display: true,
          drawBorder: true,
          drawOnChartArea: true,
          drawTicks: true,
        },
      },
      y: {
        type: 'linear',
        min: -10,
        max: 10,
        grid: {
          display: true,
          drawBorder: true,
          drawOnChartArea: true,
          drawTicks: true,
        },
      },
    },
  },
});

 // Function to get drop locations and add them to the chart
  async function getDropLocations() {
    try {
      const response = await fetch('/get_drop_locations');
      const dropLocations = await response.json();

      // Add drop locations to the chart
      dropLocations.forEach(location => {
        droneCoordsChart.data.datasets[2].data.push({
          x: location.coords.x,
          y: location.coords.y,
          label: location.alias,
        });
      });

      droneCoordsChart.update();
    } catch (error) {
      console.error('Error fetching drop locations:', error);
    }
  }

  // Call getDropLocations once the page is loaded
  window.addEventListener('load', getDropLocations);


const MAX_DATA_POINTS = 10;

// Function to update the plot with new data
function updateDroneCoords() {
  fetch('/get_drone_coords')
    .then(response => response.json())
    .then(coords => {
      // Add the new data point to the beginning of the array
      droneCoordsChart.data.datasets[0].data.unshift({ x: coords.x, y: coords.y });

      // Remove the oldest data point if we have more than MAX_DATA_POINTS
      if (droneCoordsChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
        droneCoordsChart.data.datasets[0].data.pop();
      }

      droneCoordsChart.update();
    });
}
// Update the plot every .5 seconds
setInterval(updateDroneCoords, 500);

    </script>




    {% endblock %}


</body>
</html>
